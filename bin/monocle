#!/bin/bash
# Monocle/Float windows

focus() {
    local id=$1
    xdotool windowactivate $id
    xdotool windowraise $id
    xdotool windowfocus $id
}

setwin() {
    id=$1
    pos_x=$2
    pos_y=$3
    wmctrl -ir $id -b remove,maximized_vert,maximized_horz
    xdotool windowmove $id $pos_x $pos_y
}

monocle() {
    local desktop=$(xdotool get_desktop)
    local id=$(xdotool getactivewindow)
    local windows=($(wmctrl -xl 2>/dev/null | grep -E "\s+${desktop}\s+" | \
                         tr -s '[:blank:]' |  awk '{print $1}'))
    for win in ${windows[@]}; do
        xdotool windowmove $win 0 0
        wmctrl -ir $win -b add,maximized_vert,maximized_horz
    done
    focus $id
}

float() {
    local desktop=$(xdotool get_desktop)
    local id=$(xdotool getactivewindow)
    local mw=$(xwininfo -root | grep Width | cut -d: -f2 | tr -d ' ')
    local mh=$(xwininfo -root | grep Height | cut -d: -f2 | tr -d ' ')
    local windows=($(wmctrl -xl 2>/dev/null | grep -E "\s+${desktop}\s+" | \
                         tr -s '[:blank:]' |  awk '{print $1}'))
    local num=${#windows[@]}
    for ((i=0; i<$num; i++)); do
        local win=${windows[$i]}
        local width=$(xwininfo -id $win | grep Width | cut -d: -f2 | tr -d ' ')
        local height=$(xwininfo -id $win | grep Height | cut -d: -f2 | tr -d ' ')
        local c=$(($i%4))
        case $c in
            0 )
                setwin $win 0 0
                ;;
            1 )
                setwin $win $(($mw-$width)) 0
                ;;
            2 )
                setwin $win 0 $(($mh-$height))
                ;;
            3 )
                setwin $win $(($mw-$width)) $(($mh-$height))
                ;;
        esac
    done
    focus $id
}

usage() {
    local app=$(basename $0)
    cat <<EOF
$app  {m|f}
m   -- monocle
f   -- float
EOF
}

main() {
    local kind=$1
    case $kind in
        m )
            monocle
            ;;
        f )
            float
            ;;
        * )
            usage
            ;;
    esac
}

main $@
