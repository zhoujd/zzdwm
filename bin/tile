#!/bin/bash
# tile windows

gap=5
maxstack=4
mw=$(xwininfo -root | grep Width | cut -d: -f2 | tr -d ' ')
mh=$(xwininfo -root | grep Height | cut -d: -f2 | tr -d ' ')
fw=$(($mw-$gap*2))
fh=$(($mh-$gap*2))
hw=$((($mw-$gap*3)/2))
hh=$((($mh-$gap*3)/2))

focus() {
    local id=$1
    xdotool windowactivate $id
    xdotool windowraise $id
    xdotool windowfocus $id
}

prepare() {
    local id=$1
    wmctrl -ir $id -b remove,maximized_vert,maximized_horz
}

setwin() {
    local id=$1
    local pos_x=$2
    local pos_y=$3
    local size_x=$4
    local size_y=$5
    xdotool windowmove $id $pos_x $pos_y
    xdotool windowsize $id $size_x $size_y
}

main() {
    local desktop=$(xdotool get_desktop)
    local id=$(xdotool getactivewindow)
    local windows=($(wmctrl -xl 2>/dev/null | grep -E "\s+${desktop}\s+" | \
                         tr -s '[:blank:]' |  awk '{print $1}'))
    local num=${#windows[@]}
    local stacks=()
    for w in ${windows[@]}; do
        if [[ $w -ne $id ]]; then
          stacks+=($w)  
        fi
    done
    local nstack=${#stacks[@]}
    local ns=$nstack
    if [[ $nstack -gt $maxstack ]]; then
        ns=$maxstack
    fi
    local ch=$((($mh-($ns+1)*$gap)/$ns))
    local x=$(($hw+2*$gap))
    for ((i=0; i<$nstack; i++)); do
        local win=${stacks[$i]}
        local n=$(($i%$ns))
        local y=$((($gap+$ch)*$n+$gap))
        prepare $win
        setwin $win $x $y $hw $ch
    done
    prepare $id
    setwin $id $gap $gap $hw $((($ch+$gap)*$ns-$gap))
    focus $id
}

main $@
