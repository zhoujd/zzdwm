#!/bin/bash

if [[ -z $1 ]]; then
    cat <<EOF
Usage:
$(basename $0) {app}
EOF
    exit 1
fi

app=${1}
windows=$(wmctrl -xl 2>/dev/null | grep -i $app)
num=$(echo "$windows" | wc -l)

app_run() {
    hash $app 2> /dev/null
    if [ $? -eq 0 ]; then
        exec $app
    else
        echo "No $app can been found!"
    fi
}

app_menu() {
    windows=$(echo "$windows" | tr -s '[:blank:]' |  cut -d ' ' -f 3-3,5- | \
                  sed 's/^[a-zA-Z0-9-]*\.//' | sort | uniq)
    # Add spaces to align the WM_NAMEs of the windows
    max=$(echo "$windows" | awk '{cur=length($1); \
                                  max=(cur>max?cur:max)} END{print max}')
    windows=$(echo "$windows" | \
                  awk -v max="$max" \
                      '{cur=length($1); printf $1; \
                        for(i=0; i < max - cur + 1; i++) printf " "; \
                        $1 = ""; printf "%s\n", $0}')
    target=$(echo "$windows" | dmenu -l 10 -i -p app | \
                 tr -s '[:blank:]' | cut -d ' ' -f 2-)
    if [[ -n $target ]]; then
        wmctrl -a "$target"
    fi
}

case $num in
    1 )
        wmctrl -a "$app"
        ;;
    0 )
        app_run
        ;;
    * )
        app_menu
        ;;
esac
